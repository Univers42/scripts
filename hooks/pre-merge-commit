#!/bin/sh
# ─────────────────────────────────────────────────────────
#  pre-merge-commit — Auto-pull before merge, ask on failure
#  Bypass: SKIP_PRE_MERGE=1 git merge …
# ─────────────────────────────────────────────────────────
. "$(dirname "$0")/log_hook.sh"

if [ "${SKIP_PRE_MERGE:-0}" = "1" ]; then
	log_warn "pre-merge-commit: hook bypassed via SKIP_PRE_MERGE=1"
	exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT" || exit 0

branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"
if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
	exit 0
fi

# If no upstream configured, nothing to pull
if ! git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
	log_debug "No upstream for '$branch' — skipping pre-merge pull."
	exit 0
fi

upstream="$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null)"
log_info "Pre-merge: fast-forward pull from '$upstream' for '$branch'…"

if git pull --ff-only >/dev/null 2>&1; then
	log_success "Pre-merge auto-pull succeeded for '$branch'."
	exit 0
fi

# Pull failed — ask user
log_warn "Pre-merge auto-pull failed (non-fast-forward or network)."

# Non-interactive auto-allow (CI)
if [ "${GIT_CONFIRM_MERGE:-}" = "yes" ] || [ "${GIT_CONFIRM_MERGE:-}" = "1" ]; then
	log_warn "GIT_CONFIRM_MERGE=yes — proceeding despite failed pull."
	exit 0
fi

if [ -r /dev/tty ]; then
	printf "Pre-merge pull failed. Proceed with merge anyway? [y/N]: " > /dev/tty
	read -r answer < /dev/tty || answer=""
	case "$answer" in
		y|Y|yes|YES|Yes)
			log_info "User chose to proceed with merge."
			exit 0
			;;
		*)
			log_error "Merge aborted. Run 'git pull' and resolve upstream changes first."
			exit 1
			;;
	esac
else
	log_error "Non-interactive environment — aborting merge. Run 'git pull' first."
	exit 1
fi
